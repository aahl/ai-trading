name: Trading with Claude code

on:
  schedule:
    - cron: '1 * * * *'
  workflow_dispatch:
    inputs:
      prompt:
        description: Prompt for Claude code
        default: ''

jobs:
  trading:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Checkout branch
        run: |
          BRANCH_NAME="${{ vars.TRADING_BRANCH || 'trading' }}"
          git checkout "$BRANCH_NAME" 2>/dev/null || git checkout -b "$BRANCH_NAME"
          echo "TRADING_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      - name: Set up Python & Tools
        run: |
          uv python install
          uv tool install -U mcp-aktools
          uv tool install -U mcp-notify
          uv tool install -U mcp-okx
          uv tool list

      - name: Create MCP Config
        run: |
          cat > /tmp/mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "aktools": {
                "command": "uvx",
                "args": ["mcp-aktools"]
              },
              "okx": {
                "command": "uvx",
                "args": ["mcp-okx"],
                "env": {
                  "OKX_API_KEY": "${{ secrets.OKX_DEMO_API_KEY }}",
                  "OKX_API_SECRET": "${{ secrets.OKX_DEMO_API_SECRET }}",
                  "OKX_PASSPHRASE": "${{ secrets.OKX_DEMO_PASSPHRASE }}",
                  "OKX_TRADE_FLAG": "${{ secrets.OKX_TRADE_FLAG == '0' && '0' || '1' }}"
                }
              },
              "notify": {
                "command": "uvx",
                "args": ["mcp-notify"],
                "env": {
                  "TELEGRAM_DEFAULT_CHAT": "${{ vars.TG_CHAT_MCPBTC }}",
                  "TELEGRAM_BOT_TOKEN": "${{ secrets.TELEGRAM_BOT_TOKEN }}"
                }
              },
              "hooks": {
                "command": "uv",
                "args": [
                  "--directory", "${{ github.workspace }}",
                  "run", "mcp-hooks.py"
                ]
              }
            }
          }
          EOF

      - uses: anthropics/claude-code-action@v1
        id: claude
        timeout-minutes: 30
        env:
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          ANTHROPIC_DEFAULT_OPUS_MODEL: ${{ vars.ANTHROPIC_DEFAULT_OPUS_MODEL || vars.CLAUDE_DEFAULT_MODEL }}
          ANTHROPIC_DEFAULT_HAIKU_MODEL: ${{ vars.ANTHROPIC_DEFAULT_HAIKU_MODEL || vars.CLAUDE_DEFAULT_MODEL }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: ${{ vars.ANTHROPIC_DEFAULT_SONNET_MODEL || vars.CLAUDE_DEFAULT_MODEL }}
        with:
          prompt: ${{ inputs.prompt || secrets.TRADING_PROMPT || vars.TRADING_PROMPT }}
          show_full_output: ${{ vars.CLAUDE_FULL_OUTPUT || 'false' }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          claude_args: |
            --mcp-config /tmp/mcp-config.json
            --allowedTools "Edit,Bash(git:*),WebSearch,WebFetch,mcp__aktools,mcp__okx,mcp__notify,mcp__hooks"

      - name: Commit & Push
        env:
          GITHUB_TOKEN: ${{ steps.claude.outputs.github_token || secrets.GH_PUSH_TOKEN }}
        run: |
          git config --global user.email "claude[bot]@users.noreply.github.com"
          git config --global user.name "claude[bot]"
          git add -A .
          git status
          git commit -m "ðŸ“ˆ Auto Trading Result" || echo "No changes to commit"
          git push -u origin ${{ env.TRADING_BRANCH }}
